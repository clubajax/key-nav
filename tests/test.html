<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 5//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
    <title>Test keys</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/2.5.3/mocha.css">
    <script src="../node_modules/@clubajax/on/dist/on.js"></script>
    <script src="../src/keys.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/2.5.3/mocha.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/3.5.0/chai.min.js"></script>
    <style>
        body{
            padding: 20px;
            font-family: sans-serif;
        }
        ol{
            display: block;
            border: 1px solid #ccc;
            padding: 0;
            cursor: pointer;
        }
        li{
            list-style: none;
            padding: 3px;
        }
        li[aria-current],
        td[aria-current]{
            background: #eee;
        }
        li[aria-selected],
        td[aria-selected]{
            background: #333;
            color: white;
        }
        tr[aria-current]{
            background: #ff9295;
        }
        tr[aria-selected]{
            background: red;
        }
        table{
            border: 2px solid #333;
            border-collapse: collapse;
        }
        td{
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>keys test</h1>
    <div id="mocha"></div>
    <ol id="list" tabindex="0">
        <li>uno</li>
        <li>dos</li>
        <li>tres</li>
        <li>cuatro</li>
        <li>cinco</li>
    </ol>

    <table tabindex="0" id="table">
        <thead>
            <tr><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th></tr>
        </thead>
        <tbody>
            <tr><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td></tr>
            <tr><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td></tr>
            <tr><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td></tr>
            <tr><td>16</td><td>17</td><td>18</td><td>19</td><td>20</td></tr>
            <tr><td>21</td><td>22</td><td>23</td><td>24</td><td>25</td></tr>
        </tbody>
    </table>
    <script>

        mocha.setup('tdd');

        suite('keys', function() {
            this.timeout(3000);
            var suite = window.suite,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect;


            function xsuite () {}
            function xtest () {}
            function byId (id) {
                return document.getElementById(id);
            }
            function addItems (listNode, amount) {
                amount = amount || 1;
                var
                    i,
                    items = ['seis', 'siete', 'ocho', 'nueve', 'diez'],
                    item,
                    node;
                for( i = 0; i < amount; i++){
                    item = items.shift();
                    node = document.createElement('li');
                    node.innerHTML = item;
                    listNode.appendChild(node);
                }
            }

            suite('arrow keys', function () {
                test('it should select and highlight the first item by default', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[0]);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[0]);
                    controller.destroy();
                });

                test('it should unselect and unhighlight when destroyed', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    controller.destroy();
                    expect(node.querySelector('[aria-selected]')).to.equal(null);
                    expect(node.querySelector('[aria-current]')).to.equal(null);
                    // already destroyed
                });

                test('it should highlight, but not select, the next node on arrow down', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    on.emit(node, 'keydown', {key: 'ArrowDown'}, true);
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[0]);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[1]);
                    controller.destroy();
                });

                test('it should select on Enter', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    on.emit(node, 'keydown', {key: 'ArrowDown'}, true);
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[0]);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[1]);
                    on.emit(node, 'keydown', {key: 'Enter'}, true);
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[1]);
                    controller.destroy();
                });

                test('it should highlight the last node on arrow up', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    on.emit(node, 'keydown', {key: 'ArrowUp'}, true);
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[0]);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[node.children.length-1]);
                    on.emit(node, 'keydown', {key: 'ArrowDown'}, true);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[0]);
                    controller.destroy();
                });

            });

            suite('click', function () {
                test('it should highlight and select on click', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    on.emit(node.children[2], 'click');
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[2]);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[2]);
                    controller.destroy();
                });
            });

            suite('search', function () {
                test('it should select a node on alpha input', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    on.emit(node, 'keydown', {key: 't'}, true);
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[2]);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[2]);
                    controller.destroy();
                });
                test('it should select a different node on two alpha inputs', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    on.emit(node, 'keydown', {key: 'c'}, true);
                    on.emit(node, 'keydown', {key: 'i'}, true);
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[4]);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[4]);
                    controller.destroy();
                });
            });

            suite('programmatic', function () {
                test('it should select a node with setSelected()', function () {
                    var node = byId('list'),
                        controller = keys(node);
                    controller.setSelected(node.children[2]);
                    expect(node.querySelector('[aria-selected]')).to.equal(node.children[2]);
                    expect(node.querySelector('[aria-current]')).to.equal(node.children[2]);
                    controller.destroy();
                });
            });

            suite('roles', function () {
                test('it should add roles to children if in options', function () {
                    var node = byId('list'),
                        controller = keys(node, {roles:true});
                    window.node = node;
                    expect(node.querySelectorAll('[role="listitem"]').length).to.equal(5);
                    controller.destroy();
                });
                test('it should add roles to added children', function (done) {
                    var node = byId('list'),
                        controller = keys(node, {roles:true});
                    window.node = node;
                    expect(node.querySelectorAll('[role="listitem"]').length).to.equal(5);
                    addItems(node, 2);
                    setTimeout(function () {
                        expect(node.querySelectorAll('[role="listitem"]').length).to.equal(7);
                        controller.destroy();
                        done();
                    }, 100);

                });
            });

            suite('multi-select', function () {
                test('it should select multiple on control-click', function () {
                    var node = byId('list'),
                        controller = keys(node, {multiple:true});
                    on.emit(node.children[2], 'click');
                    on.emit(document, 'keydown', {key:'Meta'});
                    on.emit(node.children[3], 'click');

                    expect(node.querySelectorAll('[aria-selected]').length).to.equal(2);
                    controller.destroy();
                    on.emit(document, 'keyup');
                });

                test('it should select multiple on shift-click', function () {
                    var node = byId('list'),
                        controller = keys(node, {multiple:true});
                    on.emit(node.children[1], 'click');
                    on.emit(document, 'keydown', {key:'Shift'});
                    on.emit(node.children[3], 'click');
                    expect(node.querySelectorAll('[aria-selected]').length).to.equal(3);
                    on.emit(document, 'keyup');
                    controller.destroy();
                });

                test.only('it should select multiple on shift-click (select upward)', function () {
                    var node = byId('list'),
                        controller = keys(node, {multiple:true});
                    on.emit(node.children[3], 'click');
                    on.emit(document, 'keydown', {key:'Shift'});
                    on.emit(node.children[1], 'click');
                    expect(node.querySelectorAll('[aria-selected]').length).to.equal(3);
                    on.emit(document, 'keyup');
                    controller.destroy();
                });
            });

            suite('selection', function () {
                test('it should default to the first item selected', function () {
                    var node = byId('list'),
                        controller = keys(node, {}),
                        selected = node.querySelectorAll('[aria-selected]');

                    expect(selected.length).to.equal(1);
                    controller.destroy();
                });

                test('it should *not* default to the first item selected', function () {
                    var node = byId('list'),
                        controller = keys(node, {noDefault: true}),
                        selected = node.querySelectorAll('[aria-selected]');

                    expect(selected.length).to.equal(0);
                    controller.destroy();
                });

                test('it should select none with Escape', function () {
                    var node = byId('list'),
                        controller = keys(node, {}),
                        selected = node.querySelectorAll('[aria-selected]');

                    expect(selected.length).to.equal(1);
                    on.emit(node, 'keydown', {key:'Escape'});
                    expect(node.querySelectorAll('[aria-selected]').length).to.equal(0);
                    controller.destroy();
                });

                test('it should *not* select none with Escape', function () {
                    var node = byId('list'),
                        controller = keys(node, {canSelectNone: false}),
                        selected = node.querySelectorAll('[aria-selected]');

                    expect(selected.length).to.equal(1);
                    on.emit(node, 'keydown', {key:'Escape'});
                    expect(node.querySelectorAll('[aria-selected]').length).to.equal(1);
                    controller.destroy();
                });
            });

            suite('table', function () {
                test('it should navigate a table', function () {
                    var
                        sel = function (node) {
                            return node.hasAttribute('selected');
                        },
                        hi = function (node) {
                            return node.hasAttribute('aria-current');
                        },
                        node = byId('table'),
                        controller = keys(node, {}),
                        cells = node.querySelectorAll('td');

                    expect(sel(cells[0])).to.equal(true);
                    on.emit(node, 'keydown', {key:'ArrowDown'});
                    expect(hi(cells[5])).to.equal(true);
                    on.emit(node, 'keydown', {key:'ArrowUp'});
                    on.emit(node, 'keydown', {key:'ArrowUp'});
                    expect(hi(cells[20])).to.equal(true);
                    on.emit(node, 'keydown', {key:'ArrowRight'});
                    on.emit(node, 'keydown', {key:'ArrowRight'});
                    on.emit(node, 'keydown', {key:'ArrowLeft'});
                    expect(hi(cells[21])).to.equal(true);
                    on.emit(node, 'keydown', {key:'Enter'});
                    expect(sel(cells[21])).to.equal(true);
                    //controller.destroy();
                });
            });
        });

        mocha.run();

    </script>
</body>
</html>
