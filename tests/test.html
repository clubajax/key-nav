<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 5//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
    <title>Test keys</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/2.5.3/mocha.css">
    <script src="../node_modules/@clubajax/on/dist/on.js"></script>
    <script src="../node_modules/@clubajax/dom/src/dom.js"></script>
    <script src="../src/keys.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/2.5.3/mocha.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/3.5.0/chai.min.js"></script>
    <style>
        body{
            padding: 20px;
            font-family: sans-serif;
        }
        ol{
            display: block;
            border: 1px solid #ccc;
            padding: 0;
            cursor: pointer;
        }
        li{
            list-style: none;
            padding: 3px;
        }
        li[aria-current],
        td[aria-current]{
            background: #eee;
        }
        li[aria-selected],
        td[aria-selected]{
            background: #333;
            color: white;
        }
        tr[aria-current]{
            background: #ff9295;
        }
        tr[aria-selected]{
            background: red;
        }
        table{
            border: 2px solid #333;
            border-collapse: collapse;
        }
        td{
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>keys test</h1>
    <div id="mocha"></div>
    <input />
    <ol id="list" tabindex="0">
        <li>uno</li>
        <li>dos</li>
        <li>tres</li>
        <li>cuatro</li>
        <li>cinco</li>
    </ol>

    <table tabindex="0" id="table">
        <thead>
            <tr><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th></tr>
        </thead>
        <tbody>
            <tr><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td></tr>
            <tr><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td></tr>
            <tr><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td></tr>
            <tr><td>16</td><td>17</td><td>18</td><td>19</td><td>20</td></tr>
            <tr><td>21</td><td>22</td><td>23</td><td>24</td><td>25</td></tr>
        </tbody>
    </table>
    <script>

        mocha.setup('tdd');

        suite('keys', function() {
            this.timeout(3000);
            const 
                suite = window.suite,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect,
                EVENTS = {
                    CLICK: 'mousedown'
                };

            let node = byId('list');
            
            function tableMode () {
                node = byId('table');
            }
            function byId (id) {
                return document.getElementById(id);
            }
            function addItems (listNode, amount) {
                amount = amount || 1;
                let
                    i,
                    items = ['seis', 'siete', 'ocho', 'nueve', 'diez'],
                    item,
                    node;
                for( i = 0; i < amount; i++){
                    item = items.shift();
                    node = document.createElement('li');
                    node.innerHTML = item;
                    listNode.appendChild(node);
                }
            }
            function key (which) {
                on.emit(node, 'keydown', {key: which}, true);
            }
            function keyup(which) {
                on.emit(document, 'keyup', {key: which}, true);
            }

            suite('arrow keys', function () {
                test('it should select and highlight the first item by default', function () {
                    const controller = keys(node, {defaultToFirst: true});
                    expect(dom.query('[aria-selected]')).to.equal(node.children[0]);
                    expect(dom.query('[aria-current]')).to.equal(node.children[0]);
                    controller.destroy();
                });

                test('it should unselect and unhighlight when destroyed', function () {
                    const controller = keys(node);
                    controller.destroy();
                    expect(dom.query('[aria-selected]')).to.equal(null);
                    expect(dom.query('[aria-current]')).to.equal(null);
                    // already destroyed
                });

                test('it should highlight, but not select, the next node on arrow down', function () {
                    const controller = keys(node, {defaultToFirst: true});
                    key('ArrowDown');
                    expect(dom.query('[aria-selected]')).to.equal(node.children[0]);
                    expect(dom.query('[aria-current]')).to.equal(node.children[1]);
                    controller.destroy();
                });

                test('it should select on Enter', function () {
                    const controller = keys(node);
                    key('ArrowDown');
                    expect(dom.query('[aria-current]')).to.equal(node.children[1]);
                    on.emit(node, 'keydown', {key: 'Enter'}, true);
                    expect(dom.query('[aria-selected]')).to.equal(node.children[1]);
                    controller.destroy();
                });

                test('it should highlight the last node on arrow up', function () {
                    const controller = keys(node);
                    key('ArrowUp');
                    expect(dom.query('[aria-current]')).to.equal(node.children[node.children.length-1]);
                    key('ArrowDown');
                    expect(dom.query('[aria-current]')).to.equal(node.children[0]);
                    controller.destroy();
                });

            });

            suite('click', function () {
                test('it should highlight and select on click', function () {
                    const controller = keys(node);
                    on.emit(node.children[2], EVENTS.CLICK);
                    expect(dom.query('[aria-selected]')).to.equal(node.children[2]);
                    expect(dom.query('[aria-current]')).to.equal(node.children[2]);
                    controller.destroy();
                });
            });

            suite('search', function () {
                test('it should select a node on alpha input', function () {
                    const controller = keys(node);
                    key('t');
                    expect(dom.query('[aria-selected]')).to.equal(node.children[2]);
                    expect(dom.query('[aria-current]')).to.equal(node.children[2]);
                    controller.destroy();
                });
                test('it should select a different node on two alpha inputs', function () {
                    const controller = keys(node);
                    key('c');
                    key('i');
                    expect(dom.query('[aria-selected]')).to.equal(node.children[4]);
                    expect(dom.query('[aria-current]')).to.equal(node.children[4]);
                    controller.destroy();
                });
            });

            suite('programmatic', function () {
                test('it should select a node with setSelected()', function () {
                    const controller = keys(node);
                    controller.setSelected(node.children[2]);
                    expect(dom.query('[aria-selected]')).to.equal(node.children[2]);
                    expect(controller.getSelected()).to.equal(node.children[2]);
                    controller.destroy();
                });
                test('it should select multiple nodes with setSelected()', function () {
                    const controller = keys(node, {multiple: true});
                    controller.setSelected([node.children[0], node.children[1]]);
                    expect(dom.queryAll('[aria-selected]')[0]).to.equal(node.children[0]);
                    expect(controller.getSelected().length).to.equal(2);

                    controller.setSelected([node.children[2], node.children[4]]);
                    expect(controller.getSelected().length).to.equal(4);
                    controller.setSelected(null);
                    expect(controller.getSelected().length).to.equal(0);
                    controller.destroy();
                });
            });

            suite('roles', function () {
                test('it should add roles to children if in options', function () {
                    const controller = keys(node, {roles:true});
                    window.node = node;
                    expect(dom.queryAll('[role="listitem"]').length).to.equal(5);
                    controller.destroy();
                });
                test('it should add roles to added children', function (done) {
                    const controller = keys(node, {roles:true});
                    window.node = node;
                    expect(dom.queryAll('[role="listitem"]').length).to.equal(5);
                    addItems(node, 2);
                    setTimeout(function () {
                        expect(dom.queryAll('[role="listitem"]').length).to.equal(7);
                        controller.destroy();
                        done();
                    }, 100);

                });
            });

            suite('multi-select', function () {
                test('it should select multiple on control-click', function () {
                    const controller = keys(node, {multiple:true});
                    on.emit(node.children[2], EVENTS.CLICK);
                    key('Meta');
                    on.emit(node.children[3], EVENTS.CLICK);

                    expect(dom.queryAll('[aria-selected]').length).to.equal(2);
                    controller.destroy();
                    on.emit(document, 'keyup');
                });

                test('it should select multiple on shift-click', function () {
                    const controller = keys(node, {multiple:true});
                    on.emit(node.children[1], EVENTS.CLICK);
                    key('Shift');
                    on.emit(node.children[3], EVENTS.CLICK);
                    expect(dom.queryAll('[aria-selected]').length).to.equal(3);
                    on.emit(document, 'keyup');
                    controller.destroy();
                });

                test('it should select multiple on shift-click (select upward)', function () {
                    const controller = keys(node, {multiple:true});
                    on.emit(node.children[3], EVENTS.CLICK);
                    key('Shift');
                    on.emit(node.children[1], EVENTS.CLICK);
                    expect(dom.queryAll('[aria-selected]').length).to.equal(3);
                    keyup('Shift');
                    on.emit(node.children[4], EVENTS.CLICK);
                    expect(dom.queryAll('[aria-selected]').length).to.equal(1);
                    controller.destroy();
                });
            });

            suite('selection', function () {
                test('it should default to the first item selected', function () {
                    const controller = keys(node, {defaultToFirst: true}),
                        selected = dom.queryAll('[aria-selected]');

                    expect(selected.length).to.equal(1);
                    controller.destroy();
                });

                test('it should *not* default to the first item selected', function () {
                    const controller = keys(node, {}),
                        selected = dom.queryAll('[aria-selected]');

                    expect(selected.length).to.equal(0);
                    controller.destroy();
                });

                test('it should select none with Escape', function () {
                    const controller = keys(node, {defaultToFirst: true}),
                        selected = dom.queryAll('[aria-selected]');

                    expect(selected.length).to.equal(1);
                    key('Escape');
                    expect(dom.queryAll('[aria-selected]').length).to.equal(0);
                    controller.destroy();
                });

                test('it should *not* select none with Escape', function () {
                    const controller = keys(node, {canSelectNone: false, defaultToFirst: true}),
                        selected = dom.queryAll('[aria-selected]');

                    expect(selected.length).to.equal(1);
                    key('Escape');
                    expect(dom.queryAll('[aria-selected]').length).to.equal(1);
                    controller.destroy();
                });
            });

            suite('events', function(){
                test('it should emit events (single select)', function () {
                    let selected = null;
                    let highlighted = null;
                    on(node, 'key-select', function (e) {
                        selected = e.detail.value;
                    });
                    on(node, 'key-highlight', function (e) {
                        highlighted = e.detail.value;
                    });

                    const controller = keys(node, {multiple: false});

                    expect(selected).to.equal(null);
                    expect(highlighted).to.equal(null);

                    node.focus();
                    key('ArrowDown');
                    expect(dom.query('[aria-current="true"]')).to.equal(highlighted);
                    key('Enter');
                    expect(dom.query('[aria-selected="true"]')).to.equal(selected);

                    controller.destroy();
                });

                test('it should emit events (multiple select)', function () {

                    // TODO - refactor tests
                    // set node in suite, not in each test
                    // do:
                    // click(nodeOrIndex)
                    // key(KEY)
                    // clean up events
                    let selected;
                    let highlighted;
                    on(node, 'key-select', function (e) {
                        selected = e.detail.value;
                    });
                    on(node, 'key-highlight', function (e) {
                        highlighted = e.detail.value;
                    });
                    const controller = keys(node, {multiple: true});

                    node.focus();
                    key('Shift');
                    key('ArrowDown');
                    key('ArrowDown');
                    key('ArrowDown');

                    expect(selected.length).to.equal(3);
                    controller.destroy();
                });

                test('it should emit add dom events', function (done) {
                    let tmp;
                    let change;
                    const h = on(node, 'key-dom-change', function (e) {
                        change = e.detail;
                        expect(change.addedNodes.length).to.equal(1);
                        controller.destroy();
                        h.remove();
                        dom.destroy(tmp);
                        done();
                    });
                    const controller = keys(node);
                    tmp = dom('li', {html: 'six'}, node);
                });

                test('it should emit remove dom events', function (done) {
                    let tmp;
                    let change;
                    on(node, 'key-dom-change', function (e) {
                        change = e.detail;
                        if (change.removedNodes.length) {
                            expect(change.removedNodes.length).to.equal(1);
                            done();
                            controller.destroy();
                        } else{
                            expect(change.addedNodes.length).to.equal(1);
                            dom.destroy(tmp);
                        }
                    });
                    const controller = keys(node);
                    tmp = dom('li', {html: 'six'}, node);
                });
            });

            suite('table', function () {
                test('it should navigate a table', function () {
                    tableMode();
                    let
                        sel = function (node) {
                            return node.hasAttribute('aria-selected');
                        },
                        hi = function (node) {
                            return node.hasAttribute('aria-current');
                        },
                        controller = keys(node, {defaultToFirst: true}),
                        cells = dom.queryAll('td');

                    expect(sel(cells[0])).to.equal(true);
                    key('ArrowDown');
                    expect(hi(cells[5])).to.equal(true);
                    key('ArrowUp');
                    key('ArrowUp');
                    expect(hi(cells[20])).to.equal(true);
                    key('ArrowRight');
                    key('ArrowRight');
                    key('ArrowLeft');
                    expect(hi(cells[21])).to.equal(true);
                    key('Enter');
                    expect(sel(cells[21])).to.equal(true);
                    controller.destroy();
                });
            });

            suite('manual', function () {
                test('it turns controllers on', function () {
                    keys(byId('list'), {multiple: true});
                    // keys(byId('table'));
                });
            });
        });

        mocha.run();

    </script>
</body>
</html>
